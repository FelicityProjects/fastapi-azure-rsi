name: Deploy to Azure VM

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: 1. 깃허브 코드 가져오기
      uses: actions/checkout@v3

    - name: 2. 모든 파일 서버로 전송 (SCP)
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.KEY }}
        port: 22
        source: "."
        target: "/home/${{ secrets.USERNAME }}/trading_bot"

    - name: 3. 서버에서 프로그램 재시작 (SSH)
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.KEY }}
        port: 22
        script: |
          # 1) 작업 폴더로 이동
          mkdir -p /home/${{ secrets.USERNAME }}/trading_bot
          cd /home/${{ secrets.USERNAME }}/trading_bot
          
          # ---------------------------------------------------------
          # [수정된 부분] pip3가 없으면 자동으로 설치 (sudo 권한 사용)
          # ---------------------------------------------------------
          if ! command -v pip3 &> /dev/null; then
            echo "⚙️ pip3(설치 도구)가 없습니다. 설치를 진행합니다..."
            sudo apt-get update
            sudo apt-get install -y python3-pip
          fi
          
          # 2) 라이브러리 설치 (requirements.txt 사용)
          if [ -f requirements.txt ]; then
            echo "📦 라이브러리 설치 중..."
            pip3 install -r requirements.txt
          fi
          
          # 3) 기존 프로세스 종료
          echo "🛑 기존 프로세스 종료 중..."
          pkill -f uvicorn || true
          pkill -f rsiBolbanTrade.py || true
          
          # 포트 반환 대기
          sleep 3
          
          # 4) FastAPI 실행
          echo "🚀 FastAPI 서버 시작..."
          nohup uvicorn main:app --host 0.0.0.0 --port 8000 > api.out 2>&1 &
          
          # 5) 트레이딩 봇 실행
          echo "🤖 트레이딩 봇 시작..."
          nohup python3 rsiBolbanTrade.py > trade.out 2>&1 &
          
          echo "✅ 모든 서비스 배포 완료!"