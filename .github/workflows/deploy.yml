name: Deploy to Azure VM

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: 1. ê¹ƒí—ˆë¸Œ ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
      uses: actions/checkout@v3

    - name: 2. ëª¨ë“  íŒŒì¼ ì„œë²„ë¡œ ì „ì†¡ (SCP)
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.KEY }}
        port: 22
        source: "."
        target: "/home/${{ secrets.USERNAME }}/trading_bot"
        timeout: "10m"

    - name: 3. ì„œë²„ì—ì„œ í”„ë¡œê·¸ë¨ ì¬ì‹œì‘ (SSH)
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.KEY }}
        port: 22
        timeout: "10m"
        script: |
          export PATH=$PATH:/home/${{ secrets.USERNAME }}/.local/bin
          mkdir -p /home/${{ secrets.USERNAME }}/trading_bot
          cd /home/${{ secrets.USERNAME }}/trading_bot
          
          # ---------------------------------------------------------
          # 1) ì•ˆì „í•˜ê²Œ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ (ìì‚´ ë°©ì§€ ì½”ë“œ ì ìš©)
          # ---------------------------------------------------------
          echo "ğŸ›‘ ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ ì¤‘..."
          
          # 'grep -v grep'ì€ ìê¸° ìì‹ (ê²€ìƒ‰ ëª…ë ¹ì–´)ì„ ì œì™¸í•œë‹¤ëŠ” ëœ»ì…ë‹ˆë‹¤.
          # 'awk'ë¡œ PIDë§Œ ë½‘ì•„ì„œ kill -9ë¡œ ê°•ì œ ì¢…ë£Œí•©ë‹ˆë‹¤.
          
          # FastAPI ì¢…ë£Œ
          ps -ef | grep "uvicorn main:app" | grep -v grep | awk '{print $2}' | xargs -r kill -9
          
          # íŠ¸ë ˆì´ë”© ë´‡ ì¢…ë£Œ
          ps -ef | grep "python3 rsiBolbanTrade.py" | grep -v grep | awk '{print $2}' | xargs -r kill -9
          
          sleep 3
          
          # ---------------------------------------------------------
          # 2) ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜ (í•„ìš”ì‹œ)
          # ---------------------------------------------------------
          if [ -f requirements.txt ]; then
            pip3 install -r requirements.txt
          fi
          
          # ---------------------------------------------------------
          # 3) ì„œë¹„ìŠ¤ ì¬ì‹œì‘
          # ---------------------------------------------------------
          echo "ğŸš€ ì„œë¹„ìŠ¤ ì¬ì‹œì‘..."
          
          nohup uvicorn main:app --host 0.0.0.0 --port 8000 > api.out 2>&1 &
          nohup python3 rsiBolbanTrade.py > trade.out 2>&1 &
          
          echo "âœ… ë°°í¬ ì™„ë£Œ! (ë¡œê·¸ í™•ì¸: tail -f trade.out)"